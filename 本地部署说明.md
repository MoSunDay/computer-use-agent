# Computer Use Agent 本地部署说明

## 项目简介

Computer Use Agent 是一个基于火山引擎豆包 1.5 UI-TARS 模型的智能桌面操作代理系统。通过自然语言指令,可以让 AI 代理自动控制计算机完成各种任务。

**本地部署模式**: 本项目已配置为完全本地运行模式,无需依赖远程沙箱服务。所有服务都在本地运行,Tool Server 直接操作本地计算机。

## 系统架构

本项目包含以下服务组件:

1. **Tool Server** (端口 8102) - 工具服务器,执行实际的鼠标、键盘等操作
2. **MCP Server** (端口 8000) - MCP 协议服务器,提供工具调用接口
3. **Planner** (端口 8089) - Agent 规划器,负责任务规划和执行
4. **Frontend** (端口 3000) - Web 前端界面

### 本地模式 vs 远程沙箱模式

- **本地模式** (当前配置): 所有服务在本地运行,Tool Server 直接操作本地计算机,无需远程沙箱管理器
- **远程沙箱模式**: 需要连接到远程沙箱管理器,在远程 ECS 实例上执行操作

## 环境要求

- Python 3.12+
- Node.js 18.0+
- Yarn 包管理器
- UV (Python 包管理器)

## 快速开始

### 1. 克隆项目

```bash
git clone https://github.com/volcengine/ai-app-lab.git
cd ai-app-lab/demohouse/computer_use
```

### 2. 配置 API Key

编辑 `planner/config.toml` 文件,填入你的火山方舟 API Key:

```toml
[models.'doubao_1_5_ui_tars_250328']
api_key = "你的API Key"
```

### 3. 启动所有服务

```bash
chmod +x start-all.sh
./start-all.sh
```

启动脚本会自动:
- 创建 Python 虚拟环境
- 安装所有依赖
- 按顺序启动所有服务

### 4. 访问前端界面

在浏览器中打开: http://localhost:3000

## 服务管理

### 查看服务状态

```bash
# 查看所有服务进程
ps aux | grep -E "(tool_server|mcp_server|planner|frontend)" | grep -v grep
```

### 查看服务日志

```bash
# Tool Server 日志
tail -f /tmp/tool_server.log

# MCP Server 日志
tail -f /tmp/mcp_server.log

# Planner 日志
tail -f /tmp/planner.log

# Frontend 日志
tail -f /tmp/frontend.log
```

### 停止所有服务

```bash
./stop-all.sh
```

## 服务端口说明

| 服务 | 端口 | 说明 |
|------|------|------|
| Tool Server | 8102 | 执行实际的计算机操作 |
| MCP Server | 8000 | MCP 协议服务 |
| Planner | 8089 | Agent 任务规划 |
| Frontend | 3000 | Web 用户界面 |

## 配置说明

### 本地模式配置

本项目已配置为本地模式,主要修改包括:

#### 1. Planner 配置 (planner/config.toml)

```toml
[models.'doubao_1_5_ui_tars_250328']
name = "doubao-1.5-ui-tars-250328"
base_url = "https://ark.cn-beijing.volces.com/api/v3"
api_key = "你的API Key"  # 必填
max_action = 100  # 最大操作步数
max_images = 5    # 最大图片数量

[sandbox]
mcp_server_endpoint = "http://127.0.0.1:8000"  # MCP Server 地址
tool_server_endpoint_format = "http://127.0.0.1:8102"  # Tool Server 地址(本地模式)
manager_endpoint = ""  # 远程沙箱管理器地址(本地模式下留空)

[planner]
step_interval = 3  # 步骤间隔(秒)
action_wait_interval = 10  # 操作等待间隔(秒)
```

#### 2. Planner 代码 (planner/src/planner/app.py)

使用 `LocalSandboxManager` 而不是 `ECSSandboxManager`:

```python
# 使用本地沙箱管理器,无需远程 ECS
sandbox_manager = LocalSandboxManager()
```

#### 3. Frontend API 配置

所有沙箱相关的 API 路由都已配置为本地模式:
- `frontend/src/app/api/sandbox/list/route.ts` - 返回本地虚拟沙箱
- `frontend/src/app/api/sandbox/create/route.ts` - 返回本地虚拟沙箱
- `frontend/src/app/api/sandbox/delete/route.ts` - 本地模式下无操作
- `frontend/src/app/api/sandbox/terminal-url/route.ts` - 本地模式下返回空

每个文件中都有 `USE_LOCAL_MODE = true` 开关。

### 切换到远程沙箱模式

如果需要使用远程沙箱,需要修改以下配置:

#### 1. Planner 代码

```python
# 修改 planner/src/planner/app.py
sandbox_manager = ECSSandboxManager()  # 改为使用 ECS 沙箱管理器
```

#### 2. Planner 配置

```toml
# 修改 planner/config.toml
[sandbox]
manager_endpoint = "https://your-sandbox-manager.com"  # 填入沙箱管理器地址
```

#### 3. Frontend API

将所有沙箱 API 路由中的 `USE_LOCAL_MODE` 改为 `false`:

```typescript
const USE_LOCAL_MODE = false;  // 使用远程沙箱模式
```

### MCP Server 配置 (mcp_server/settings.toml)

```toml
[tool_server]
local = false  # 是否本地部署
endpoint = "127.0.0.1:8102"  # Tool Server 地址
```

## 使用说明

1. 启动所有服务后,访问 http://localhost:3000
2. 在界面中输入自然语言指令,例如:
   - "打开浏览器并访问百度"
   - "创建一个新的文本文件"
   - "截取当前屏幕"
3. AI 代理会自动分析任务并执行相应操作
4. 可以在界面中实时查看执行过程和结果

## 常见问题

### 1. 端口被占用

如果遇到端口被占用的错误,可以:
- 检查是否有其他服务占用了相应端口
- 修改配置文件中的端口号
- 使用 `lsof -i :端口号` 查看占用情况

### 2. API Key 无效

确保:
- API Key 正确填写在 `planner/config.toml` 中
- API Key 有足够的额度
- 网络可以访问火山方舟 API

### 3. 服务启动失败

查看对应的日志文件:
```bash
tail -f /tmp/tool_server.log
tail -f /tmp/mcp_server.log
tail -f /tmp/planner.log
tail -f /tmp/frontend.log
```

### 4. Python 版本问题

本项目需要 Python 3.12+,如果系统 Python 版本较低:
- 使用 pyenv 或 conda 安装 Python 3.12
- 修改启动脚本中的 Python 版本要求

## 手动启动服务

如果需要手动启动各个服务:

### Tool Server
```bash
cd tool_server
uv venv --python 3.12
source .venv/bin/activate
uv sync
python main.py
```

### MCP Server
```bash
cd mcp_server
uv venv --python 3.12
source .venv/bin/activate
uv sync
export FASTMCP_PORT=8000
export TOOL_SERVER_ENDPOINT="127.0.0.1:8102"
uv run mcp-server
```

### Planner
```bash
cd planner
uv venv --python 3.12
source .venv/bin/activate
uv sync
uv run src/planner/main.py
```

### Frontend
```bash
cd frontend
yarn install
yarn dev
```

## 开发说明

- Frontend: Next.js + React + TypeScript
- Backend: FastAPI + Python
- AI Model: 豆包 1.5 UI-TARS
- Protocol: MCP (Model Context Protocol)

## 相关链接

- [项目 GitHub](https://github.com/volcengine/ai-app-lab)
- [火山方舟控制台](https://console.volcengine.com/ark)
- [豆包 1.5 UI-TARS 模型](https://console.volcengine.com/ark/region:ark+cn-beijing/model/detail?Id=doubao-1-5-ui-tars)

## 许可证

本项目采用火山方舟原型应用软件自用许可协议。

## 联系我们

如有问题,请加入飞书群: [应用实验室开发者沟通群](https://applink.larkoffice.com/client/chat/chatter/add_by_link?link_token=a5aq182d-ad9b-4867-8464-609f1ee8cb34)

