# macOS 权限问题排查指南

## 问题症状

运行 `./test-macos-permissions.sh` 时看到：

```
❌ PyAutoGUI 无法正确移动鼠标
⚠️  鼠标位置没有改变，说明缺少辅助功能权限
```

---

## 快速解决方案

### 方法 1: 使用自动化助手（推荐）

```bash
./setup-permissions.sh
```

这个脚本会：
1. 自动打开系统设置
2. 引导您完成权限设置
3. 提供详细的步骤说明

### 方法 2: 手动设置

按照 [macOS权限设置指南.md](./macOS权限设置指南.md) 中的步骤操作。

---

## 详细排查步骤

### 步骤 1: 确认您使用的终端应用

首先确定您正在使用哪个终端应用：

- **Terminal** (系统自带)
- **iTerm2**
- **VS Code 内置终端**
- **其他终端应用**

**如何确认**:
```bash
echo $TERM_PROGRAM
```

输出示例：
- `Apple_Terminal` → 使用的是系统自带 Terminal
- `iTerm.app` → 使用的是 iTerm2
- `vscode` → 使用的是 VS Code

---

### 步骤 2: 打开系统设置

**方法 1**: 点击屏幕左上角的  图标 → 系统设置

**方法 2**: 按 `Cmd + Space`，输入"系统设置"，按回车

**方法 3**: 运行命令自动打开：
```bash
open "x-apple.systempreferences:com.apple.preference.security?Privacy_Accessibility"
```

---

### 步骤 3: 设置辅助功能权限

1. 在系统设置中，点击左侧的 **"隐私与安全性"**
2. 在右侧列表中，找到并点击 **"辅助功能"**
3. 点击左下角的 **🔒 锁图标**（需要输入管理员密码）
4. 点击 **+ 按钮**
5. 在弹出的文件选择器中：
   - 按 `Cmd + Shift + G` 打开"前往文件夹"
   - 输入以下路径之一：
     - Terminal: `/System/Applications/Utilities/Terminal.app`
     - iTerm2: `/Applications/iTerm.app`
     - VS Code: `/Applications/Visual Studio Code.app`
6. 选择应用并点击"打开"
7. **确保应用旁边的开关是开启状态**（蓝色）

---

### 步骤 4: 设置屏幕录制权限

1. 在"隐私与安全性"下，找到并点击 **"屏幕录制"**
2. 如果锁是锁定的，点击 🔒 解锁
3. 点击 **+ 按钮**
4. 选择与步骤 3 相同的终端应用
5. **确保应用旁边的开关是开启状态**（蓝色）

---

### 步骤 5: 重启终端（重要！）

**⚠️ 这一步非常重要！权限更改只有在重启终端后才会生效。**

1. **完全退出**终端应用（按 `Cmd + Q`，不是只关闭窗口）
2. 重新打开终端应用
3. 进入项目目录：
   ```bash
   cd /Users/amos/opt/CodeProjects/computer-user-agent/computer-use-agent
   ```
4. 运行测试脚本：
   ```bash
   ./test-macos-permissions.sh
   ```

---

### 步骤 6: 验证权限

运行测试脚本后，您应该看到：

```
✅ PyAutoGUI 可以正常移动鼠标
✅ 辅助功能权限已正确设置
✅ 成功截图 (尺寸: 3024x1964)
✅ 屏幕录制权限已正确设置
✅ 所有权限测试通过！
```

---

## 常见问题

### Q1: 我已经添加了终端应用，但还是不工作

**可能原因**:
1. 没有完全退出并重新打开终端
2. 添加的应用不正确
3. 开关没有开启

**解决方法**:
1. 确保完全退出终端（`Cmd + Q`）
2. 重新打开终端
3. 检查系统设置中的开关是否为蓝色（开启状态）
4. 如果还不行，尝试移除应用后重新添加

---

### Q2: 找不到我的终端应用

**VS Code 用户**:
- 路径: `/Applications/Visual Studio Code.app`
- 如果找不到，尝试搜索"Visual Studio Code"

**iTerm2 用户**:
- 路径: `/Applications/iTerm.app`
- 如果找不到，检查是否安装在其他位置

**Homebrew 安装的应用**:
- 可能在 `/opt/homebrew/Caskroom/` 下

---

### Q3: 权限列表中已经有我的终端，但还是不工作

**解决方法**:
1. 在权限列表中，选中您的终端应用
2. 点击 **- 按钮** 移除它
3. 点击 **+ 按钮** 重新添加
4. 确保开关是开启状态
5. 完全退出并重新打开终端
6. 重新测试

---

### Q4: 测试脚本显示"权限测试失败"

**检查清单**:
- [ ] 已在"辅助功能"中添加终端应用
- [ ] 已在"屏幕录制"中添加终端应用
- [ ] 两个权限的开关都是开启状态（蓝色）
- [ ] 已完全退出并重新打开终端
- [ ] 在正确的终端应用中运行测试

---

### Q5: 我不想给这些权限怎么办？

**回答**: Computer Use Agent **必须**有这些权限才能工作。

如果不授予权限：
- ❌ AI 无法移动鼠标
- ❌ AI 无法点击
- ❌ AI 无法输入文字
- ❌ AI 无法截图

这些权限是 AI 控制桌面的核心功能。

**安全建议**:
1. 仅在测试环境使用
2. 使用完毕后可以在系统设置中移除权限
3. 或者使用单独的 macOS 用户账户运行

---

### Q6: 重启电脑后权限失效了

**可能原因**: macOS 安全策略

**解决方法**:
1. 重新打开系统设置
2. 检查权限是否还在列表中
3. 如果在，确保开关是开启状态
4. 如果不在，重新添加

---

## 高级排查

### 使用命令行检查权限

```bash
# 检查辅助功能权限
sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db \
  "SELECT service, client, allowed FROM access WHERE service='kTCCServiceAccessibility';"
```

**注意**: 这个命令可能需要 root 权限。

---

### 查看系统日志

```bash
# 查看权限相关的系统日志
log show --predicate 'subsystem == "com.apple.TCC"' --last 1h
```

---

### 完全重置权限（最后手段）

```bash
# 重置所有 TCC 权限（需要重启）
sudo tccutil reset All
```

**⚠️ 警告**: 这会重置所有应用的所有权限，请谨慎使用！

---

## 测试成功后的下一步

1. **启动所有服务**:
   ```bash
   ./start-all.sh
   ```

2. **访问前端**:
   ```
   http://localhost:3000
   ```

3. **测试 AI 控制**:
   - 在界面中输入: "移动鼠标到屏幕中央"
   - 观察鼠标是否真的移动了

---

## 需要帮助？

如果按照本指南操作后仍然无法工作：

1. 检查日志文件:
   ```bash
   tail -f /tmp/tool_server.log
   ```

2. 运行详细测试:
   ```bash
   cd tool_server
   source .venv/bin/activate
   python3 -c "import pyautogui; print(pyautogui.position()); pyautogui.moveTo(500, 500); print(pyautogui.position())"
   ```

3. 查看完整的权限设置指南:
   ```bash
   cat macOS权限设置指南.md
   ```

---

**最后更新**: 2025-11-02

